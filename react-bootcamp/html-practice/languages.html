<!DOCTYPE html>
<html>

<head>
    <title>Popular Repos</title>
    <script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src='https://unpkg.com/babel-standalone@6/babel.min.js'></script>
</head>

<body>
    <div id='app'></div>
    <script>
        window.API = {
            fetchPopularRepos(language) {
                // "language" can be "javascript", "ruby", "python", or "all"
                const encodedURI = encodeURI(`https://api.github.com/search/repositories?q=stars:>1+language:${language}&sort=stars&order=desc&type=Repositories`)

                return fetch(encodedURI)
                    .then((data) => data.json())
                    .then((repos) => repos.items)
                    .catch((error) => {
                        console.warn(error)
                        return null
                    });
            }
        }
    </script>

    <script type='text/babel'>
        class Loading extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    text: 'Loading'
                };
            }
            componentDidMount() {
                const stopper = this.state.text + '...';

                this.interval = window.setInterval(() => {
                    this.state.text === stopper
                        ? this.setState(() => ({ text: 'Loading' }))
                        : this.setState((prevState) => ({ text: prevState.text + '.' }))
                }, 300)
            }
            componentWillUnmount() {
                window.clearInterval(this.interval);
            }
            render() {
                return (
                    <p>
                        {this.state.text}
                    </p>
                )
            }
        }

        class App extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    loading: true,
                    query: "all",
                    data: []
                };

                this.fetch = this.fetch.bind(this);
                this.handleLanguageSelect = this.handleLanguageSelect.bind(this);
            }

            componentDidMount() {
                this.fetch(this.state.query);
            }

            componentDidUpdate(currentProps, currentState) {
                if (currentState.query !== this.state.query) {
                    this.fetch(this.state.query);
                }
            }

            handleLanguageSelect(query) {
                this.setState(() => {
                    return {
                        query
                    };
                });
            }

            fetch(query) {
                this.setState(() => {
                    return {
                        loading: true
                    };
                });

                API.fetchPopularRepos(query)
                    .then((data) => {
                        this.setState(() => {
                            return {
                                data,
                                loading: false,
                            };
                        });
                    });
            }

            render() {
                if (this.state.loading) {
                    return <Loading />;
                }
                else {
                    return (<div>
                        <Nav handleLanguageSelect={this.handleLanguageSelect} />
                        <h1 style={{ textAlign: "center" }}>{this.state.query}</h1>
                        <LanguagesList list={this.state.data} /></div>);
                }
            }
        }

        function Nav(props) {
            var languages = ["all", "javascript", "ruby", "python"];

            return (
                <nav>
                    <ul>
                        {languages.map((language) => (
                            <li key={language} onClick={() => props.handleLanguageSelect(language)}>{language}</li>
                        ))}
                    </ul>
                </nav>
            );
        }

        function LanguagesList(props) {
            return (
                <div>{props.list.map((item) => (
                    <ul key={item.id}>
                        <li style={{ float: "left", margin: 30 }}>
                            <ul>
                                <li><a href={item.html_url}>{item.name}</a></li>
                                <li>@{item.owner.login}</li>
                                <li>{item.stargazers_count} stars</li>
                            </ul>
                        </li>
                    </ul>
                ))}</div>
            );
        }

        ReactDOM.render(
            <App />,
            document.getElementById('app')
        )
    </script>
</body>

</html>